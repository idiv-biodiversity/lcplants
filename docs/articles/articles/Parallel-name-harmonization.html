<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>How to run lcvplants in parallel • lcvplants</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../../bootstrap-toc.css">
<script src="../../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../../pkgdown.css" rel="stylesheet">
<script src="../../pkgdown.js"></script><meta property="og:title" content="How to run lcvplants in parallel">
<meta property="og:description" content="lcvplants">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../../index.html">lcvplants</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2.0.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../../articles/articles/Parallel-name-harmonization.html">How to run lcvplants in parallel</a>
    </li>
    <li>
      <a href="../../articles/taxonomic_resolution_using_lcvplants.html">Taxonomic resolution using lcvplants</a>
    </li>
  </ul>
</li>
<li>
  <a href="../../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/idiv-biodiversity/lcvplants/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="Parallel-name-harmonization_files/header-attrs-2.11/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>How to run lcvplants in parallel</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/idiv-biodiversity/lcvplants/blob/master/vignettes/articles/Parallel-name-harmonization.Rmd" class="external-link"><code>vignettes/articles/Parallel-name-harmonization.Rmd</code></a></small>
      <div class="hidden name"><code>Parallel-name-harmonization.Rmd</code></div>

    </div>

    
    
<div id="about" class="section level2">
<h2 class="hasAnchor">
<a href="#about" class="anchor" aria-hidden="true"></a>About</h2>
<p>Some users may want to use <code>lcvplants</code> functions to perform taxonomic harmonization for many thousands of species and wish to use the entire computational capacity available to speed up the processing time. In this brief tutorial, we show how to run <code>lcvp_search</code> or <code>lcvp_fuzzy_search</code> in parallel in an efficient way to reduce computational time.</p>
</div>
<div id="should-i-run-in-parallel" class="section level2">
<h2 class="hasAnchor">
<a href="#should-i-run-in-parallel" class="anchor" aria-hidden="true"></a>Should I run in parallel?</h2>
<p>Before running the code in parallel, you should decide whether you need it. To decide that, you should take into account both the gain in processing time and the necessary time to adapt your code to run in parallel.</p>
<p>Check the following graph to decide whether do you think it is worth running the code in parallel. It shows the results of a test on a notebook using 3 cores and three different strategies (sequential, multicore, and multisession) to harmonize random samples of names in the TRY database of different sizes.</p>
<p><img src="Parallel-name-harmonization-fig1.png" width="732"></p>
</div>
<div id="required-packages" class="section level2">
<h2 class="hasAnchor">
<a href="#required-packages" class="anchor" aria-hidden="true"></a>Required packages</h2>
<p>Here, we are going to use the framework of the <code>future</code> package to parallelize our code, as it can be easily adapted to users running the code on different operational systems. So, make sure you have the following packages installed and loaded.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/idiv-biodiversity/LCVP" class="external-link">LCVP</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/idiv-biodiversity/lcvplants" class="external-link">lcvplants</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://future.futureverse.org" class="external-link">future</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://future.apply.futureverse.org" class="external-link">future.apply</a></span><span class="op">)</span></code></pre></div>
</div>
<div id="the-dataset" class="section level2">
<h2 class="hasAnchor">
<a href="#the-dataset" class="anchor" aria-hidden="true"></a>The dataset</h2>
<p>We are going to use here as an example a random sample of 100 names from the Leipzig Catalogue of Vascular Plants database. In your code, substitute the <code>sps</code> object for your vector of species names.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>
<span class="va">sps</span> <span class="op">&lt;-</span> <span class="va">tab_lcvp</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">tab_lcvp</span><span class="op">)</span>, <span class="fl">100</span><span class="op">)</span>, <span class="fl">1</span><span class="op">]</span></code></pre></div>
</div>
<div id="running-in-parallel" class="section level2">
<h2 class="hasAnchor">
<a href="#running-in-parallel" class="anchor" aria-hidden="true"></a>Running in parallel</h2>
<div id="number-of-cores" class="section level3">
<h3 class="hasAnchor">
<a href="#number-of-cores" class="anchor" aria-hidden="true"></a>Number of cores</h3>
<p>Before parallelizing your code, you need to decide what strategy you are going to use. Most users may want to parallelize the code on a local machine with several cores (via a multicore or multisession approach). For these users, the first thing is to decide how many cores on your local machine will be used for parallelization. You can check how many cores you have using the following code:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://future.futureverse.org/reference/re-exports.html" class="external-link">availableCores</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; system </span>
<span class="co">#&gt;      4</span></code></pre></div>
<p>Decide how many of them you are going to use. Normally you may want to leave one out for other processes on your computer, but this is up to you.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cores</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://future.futureverse.org/reference/re-exports.html" class="external-link">availableCores</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span></code></pre></div>
</div>
<div id="preparing-the-data" class="section level3">
<h3 class="hasAnchor">
<a href="#preparing-the-data" class="anchor" aria-hidden="true"></a>Preparing the data</h3>
<p>The second decision concerns how to divide the data to run the code in parallel. Since all names could be searched independently, a user could tell <code>lcvp_search</code> to harmonize each species name in a different core. Although this may improve computational performance, it is not the most efficient way to do that. The <code>lcvplants</code> package was designed to optimize the computation over large vectors of plant names and we should take advantage of that. So, the best way to parallelize the code is to divide your data according to the number of cores (or machines) available.</p>
<p>We run some tests on a workstation with 8 cores to harmonize random samples of names in the TRY database, see the results below:</p>
<p><img src="Parallel-name-harmonization-fig2.png" width="723"></p>
<p>In other words, if you want to run your code using 3 cores, you should divide the total dataset into 3 subsets, and then run <code>lcvp_search</code> in 3 parallel cores. Use the following code to divide your dataset.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">blocks</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">sps</span><span class="op">)</span>, 
                         <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, length.out <span class="op">=</span> <span class="va">cores</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">blocks</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span>
<span class="va">sps_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">k</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">cores</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">sps_list</span><span class="op">[[</span><span class="va">k</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">sps</span><span class="op">[</span><span class="op">(</span><span class="va">blocks</span><span class="op">[</span><span class="va">k</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="va">blocks</span><span class="op">[</span><span class="va">k</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span><span class="op">]</span>
<span class="op">}</span></code></pre></div>
</div>
<div id="parallelization-with-the-lapply-approach" class="section level3">
<h3 class="hasAnchor">
<a href="#parallelization-with-the-lapply-approach" class="anchor" aria-hidden="true"></a>Parallelization with the lapply approach</h3>
<p>We can use the <code>lapply</code> approach applied by several packages to parallelize our code here. In our example, <code>lapply</code> can be used to apply the <code>lcvp_search</code> function on our divided list of species names (<code>sps_list</code>).</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">sps_list</span>, <span class="va">lcvp_search</span><span class="op">)</span></code></pre></div>
<p>The result will be also separated in a list with a length equal to the original input list (in this case the object <code>sps_list</code>). To combine the results, we can use the following code:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">result_comb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">result</span><span class="op">)</span></code></pre></div>
<p>Notice now that the <code>lapply</code> runs a function over a list, and each object of this list is processed independently. So, we could tell R to process each element of the list in a different core. For this, we will use the <code>future_lapply</code> function, but several other functions based on the <code>lapply</code> to run in parallel are available (e.g., <code><a href="https://rdrr.io/r/parallel/mclapply.html" class="external-link">parallel::mclapply</a></code> or <code><a href="https://rdrr.io/r/parallel/clusterApply.html" class="external-link">parallel::parLapply</a></code>). The structure to use <code>future_apply</code> is the same as before.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="va">sequential</span><span class="op">)</span>
<span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://future.apply.futureverse.org/reference/future_lapply.html" class="external-link">future_lapply</a></span><span class="op">(</span><span class="va">sps_list</span>, <span class="va">lcvp_search</span><span class="op">)</span>
<span class="va">result_comb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">result</span><span class="op">)</span></code></pre></div>
</div>
<div id="parallelization-strategy" class="section level3">
<h3 class="hasAnchor">
<a href="#parallelization-strategy" class="anchor" aria-hidden="true"></a>Parallelization strategy</h3>
<p>You may have noted that we used <code><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan(sequential)</a></code> before the code. The function <code>plan</code> allows you to decide which parallelization strategy to use. Several options are available: <code>sequential</code>, <code>multisession</code>, <code>multicore</code>, <code>cluster</code>, and <code>remote</code> (see <code><a href="https://future.futureverse.org/reference/plan.html" class="external-link">?plan</a></code> for details). If you are running the code on a local machine, the faster option is to use the <code>multicore</code> strategy (or forking approach). But this option does not work for Windows machines (or in Rstudio), which in this case, the option <code>multisession</code> (or socket approach) should be used.</p>
<p>You can check if the multicore option is available for you using the following code:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://future.futureverse.org/reference/re-exports.html" class="external-link">supportsMulticore</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; [1] FALSE</span></code></pre></div>
<p>If the answer is <code>TRUE</code> you can use the multicore option, otherwise use the multisession.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">strategy</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://future.futureverse.org/reference/re-exports.html" class="external-link">supportsMulticore</a></span><span class="op">(</span><span class="op">)</span>, 
                   <span class="st">"multicore"</span>, 
                   <span class="st">"multisession"</span><span class="op">)</span>
<span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="va">strategy</span>, workers <span class="op">=</span> <span class="va">cores</span><span class="op">)</span></code></pre></div>
<p>Then just run the code as before.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://future.apply.futureverse.org/reference/future_lapply.html" class="external-link">future_lapply</a></span><span class="op">(</span><span class="va">sps_list</span>, <span class="va">lcvp_search</span><span class="op">)</span>
<span class="va">result_comb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">result</span><span class="op">)</span></code></pre></div>
<p>This same approach shown here can be used for <code>lcvp_fuzzy_search</code>.</p>
</div>
</div>
<div id="more-about-parallel-programming" class="section level2">
<h2 class="hasAnchor">
<a href="#more-about-parallel-programming" class="anchor" aria-hidden="true"></a>More about parallel programming</h2>
<p>These are just some of the available options to run the code in parallel. If you want to know more about parallel programming you can check the following references:</p>
<ul>
<li><a href="https://bookdown.org/rdpeng/rprogdatascience/parallel-computation.html" class="external-link">The chapter 22 of the book by Roger Peng, “R programming for data science”.</a></li>
<li><a href="https://cran.r-project.org/web/packages/future/vignettes/future-1-overview.html" class="external-link">The future package tutorial.</a></li>
</ul>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Bruno Vilela, Alessandro Gentile, Martin Freiberg, Marten Winter.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link external-link">pkgdown</a> 1.6.1.9001.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
